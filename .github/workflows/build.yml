name: Build Nadekodon

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  ARTIFACT_NAME: nadekodon

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      flutter_version: ${{ steps.out.outputs.flutter_version }}
      version_name: ${{ steps.version.outputs.version_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Determine Flutter version
        id: out
        run: |
          if [ -f ".fvmrc" ]; then
            FLUTTER_VERSION=$(jq -r '.flutter' .fvmrc)
          else
            FLUTTER_VERSION="stable"
          fi
          echo "flutter_version=${FLUTTER_VERSION}" >> $GITHUB_OUTPUT

      - name: Update pubspec.yaml version using tag and run number
        id: version
        run: |
          VERSION_TAG="${GITHUB_REF_NAME#v}"
          BUILD_NUM=${GITHUB_RUN_NUMBER}
          NEW_VERSION="${VERSION_TAG}+${BUILD_NUM}"
          echo "Setting pubspec.yaml version: ${NEW_VERSION}"

          if grep -q '^version:' pubspec.yaml; then
            sed -i "s/^version:.*/version: ${NEW_VERSION}/" pubspec.yaml
          else
            echo "version: ${NEW_VERSION}" >> pubspec.yaml
          fi

          grep version pubspec.yaml
          echo "version_name=${VERSION_TAG}" >> $GITHUB_OUTPUT

      - name: Upload updated pubspec.yaml
        uses: actions/upload-artifact@v4
        with:
          name: pubspec
          path: pubspec.yaml

  build-template:
    runs-on: ${{ matrix.os }}
    needs: setup
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: linux-x64
            build_cmd: flutter build linux --release --target-platform linux-x64
            artifact_path: nadekodon-linux-x64.AppImage
          - os: windows-latest
            target: windows
            build_cmd: flutter build windows --release
            artifact_path: nadekodon-windows.zip
          - os: ubuntu-latest
            target: android-arm64
            build_cmd: flutter build apk --release --target-platform android-arm64
            artifact_path: nadekodon-android-arm64.apk

    steps:
      - uses: actions/checkout@v4

      - name: Download updated pubspec.yaml
        uses: actions/download-artifact@v4
        with:
          name: pubspec
          path: .

      - name: Install system deps (Linux only)
        if: matrix.target == 'linux-x64'
        run: |
          sudo apt update
          sudo apt install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev \
            libfuse2 libayatana-appindicator3-dev patchelf curl jq

      - name: Install Java (Android only)
        if: startsWith(matrix.target, 'android')
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: 17
          cache: gradle

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ needs.setup.outputs.flutter_version }}
          channel: stable
          cache: true

      - name: Install rinf_cli
        run: cargo install rinf_cli --force

      - name: Generate rinf bindings
        run: rinf gen

      - name: Get Flutter packages
        run: flutter pub get

      - name: Generate launcher icons
        run: dart run flutter_launcher_icons

      - name: Download yt-dlp for Android
        if: matrix.target == 'android-arm64'
        run: |
          mkdir -p assets/bin
          echo "Downloading yt-dlp_linux_aarch64 ..."
          curl -L -o assets/bin/yt-dlp https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp_linux_aarch64
          chmod +x assets/bin/yt-dlp
          echo "yt-dlp added to assets/bin"
          ls -lh assets/bin

      - name: Build app
        run: ${{ matrix.build_cmd }}

      - name: Fix RPATH (Linux only)
        if: matrix.target == 'linux-x64'
        run: |
          APP_PATH="build/linux/x64/release/bundle/${{ env.ARTIFACT_NAME }}"
          LIB_PATH="build/linux/x64/release/bundle/lib"
          for lib in "$LIB_PATH"/*.so; do
            [[ -f "$lib" ]] && patchelf --set-rpath '$ORIGIN' "$lib"
          done
          patchelf --set-rpath '$ORIGIN/lib' "$APP_PATH"

      - name: Build AppImage
        if: matrix.target == 'linux-x64'
        run: |
          echo "Building AppImage using repo AppImageBuilder.yml ..."
          wget -O appimage-builder-x86_64.AppImage https://github.com/AppImageCrafters/appimage-builder/releases/download/v1.1.0/appimage-builder-1.1.0-x86_64.AppImage
          chmod +x appimage-builder-x86_64.AppImage
          sudo mv appimage-builder-x86_64.AppImage /usr/local/bin/appimage-builder
          appimage-builder --recipe AppImageBuilder.yml --skip-test
          chmod +x ${{ matrix.artifact_path }}

      - name: Package Windows build
        if: matrix.target == 'windows'
        run: |
          echo "Creating portable Windows ZIP..."
          7z a ./${{ matrix.artifact_path }} build/windows/x64/runner/Release/*

      - name: Move Android artifact
        if: matrix.target == 'android-arm64'
        run: |
          mv build/app/outputs/flutter-apk/app-release.apk ${{ matrix.artifact_path }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}-${{ matrix.target }}
          path: ${{ matrix.artifact_path }}

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-template, setup]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Collect artifacts for release
        run: |
          mkdir -p uploads
          find dist -type f -exec cp {} uploads/ \;
          ls -lh uploads

      - name: Generate release notes
        id: notes
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          echo "Previous tag: $PREV_TAG"
          BODY="## Changelog\n"
          if [ -n "$PREV_TAG" ]; then
            COMMITS=$(git log "$PREV_TAG"..HEAD --pretty=format:"- %s (%h)" --no-merges)
          else
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges)
          fi
          BODY="${BODY}${COMMITS}"
          echo "BODY<<EOF" >> $GITHUB_ENV
          echo -e "$BODY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: ${{ env.BODY }}
          files: uploads/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
